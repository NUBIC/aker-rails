Bcsec-Rails
===========

`bcsec-rails` is the Rails plugin for Bcsec 2.0 and later.  It is a
thin wrapper around Bcsec's rack support.

Setup
-----

### Get the gem

`bcsec-rails` is a gem plugin.  In order to use it, either install the
gem at the system level or (better) include it in your bundler-using
application's Gemfile.

#### Okay

    !!!plain
    $ gem sources -a http://download.bioinformatics.northwestern.edu/gems
    $ gem install bcsec-rails

#### Better

    # in your Gemfile
    source 'http://download.bioinformatics.northwestern.edu/gems'
    gem 'bcsec-rails', '~> 2.0'

### Add it to the application

Next, configure the gem into your Rails application's environment.
(This is necessary for gem plugins even if you are using bundler.)

    # In config/environment.rb's initializer block
    config.gem "bcsec-rails", :lib => 'bcsec/rails', :version => '~> 2.0'

### Add an initializer for bcsec

Put your global configuration in an initializer. By _global
configuration_ I mean the parts that are the same no matter which
environment you are using, like the portal name and the modes.  (N.b.:
You have to put it in an initializer &mdash; if you just put it at the
end of `config/environment.rb` it won't work.)

    # In config/initializers/bcsec.rb
    Bcsec.configure do
      # The authentication protocol to use for interactive access.
      # `:form` is the default.
      ui_mode :form

      # The authentication protocol(s) to use for non-interactive
      # access.  There is no default.
      api_mode :http_basic

      # The portal to which this application belongs.  Optional.
      portal :ENU
    end

For more information on the configuration syntax and options, see the
bcsec API documentation for `Bcsec::Configuration`.

### Add per-environment configurations

In the environment initializer for each of your application's
environments, put the parts of the Bcsec configuration which are
env-specific.  E.g., you might only use the `netid` authority in staging
and production since full access to the NU LDAP servers is only
available from behind the firewall.  This means that the `authorities`
line will be env-specific.

    # In config/environments/production.rb, for example
    config.after_initialize do
      Bcsec.configure do
        # The authorities to use.  See the bcsec API documentation 
        # for `Bcsec::Authorities` for options.
        authorities :netid, :pers

        # The server-central parameters file for cc_pers, NU LDAP,
        # CAS, and policy parameters.
        central '/etc/nubic/bcsec-prod.yml'
      end
    end

Integration into your app
-------------------------

With the plugin installed, Bcsec provides a general infrastructure for
supporting authentication and authorization in your application.  If
you want to _require_ authentication or authorization for particular
resources (and I think you do), you need to do a bit more
configuration.

### Securing pages

In any controller which authentication is required, include
`Bcsec::Rails::SecuredController`.  If authentication is required for
all controllers, you can include this module in
`ApplicationController`.

If you want to further require that all actions in a controller
require that the user be a member of a certain group, you can use the
{Bcsec::Rails::SecuredController::ClassMethods#permit permit} method:

    class ManuscriptController < ActionController::Base
      include Bcsec::Rails::SecuredController
      permit :editor
    end

### Partial authorization

Bcsec also supports resources which are only partially limited to a
particular group or groups.  The helper for this is also called
{Bcsec::Rails::Application#permit? permit}:

    # In a controller action
    class DashboardController < ActionController::Base
      # ...
      def index
        if permit?(:editor)
          @manuscripts = Manuscript.all
        end
      end
    end

    # Or in a view
    <%= permit?(:editor) do %>
       @manuscripts.collect { |m| m.title }.join(', ')
    <% end %>

This permit helper is available to all controllers and views, not just
ones that mix in {Bcsec::Rails::SecuredController}.  This means you
can have a publically-accessible page which has additional/different
content for a logged-in user.

### The current user

Bcsec provides a method `current_user` to all controllers and views.
It will return a `Bcsec::User` object for the current user, or `nil`
if there isn't one.

### Overriding the unauthorized view

The message that your users will see if they try to access a resource
for which they don't have sufficient privileges is pretty spare and
unfriendly.  Applications can replace it with something prettier and
application-appropriate via rack middleware which intercepts 403
responses.  (TODO: more details and an example.)
